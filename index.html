<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Uwsgi-nginx-flask-docker-for-sinaimg by YUX-IO</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Uwsgi-nginx-flask-docker-for-sinaimg</h1>
      <h2 class="project-tagline">使用DaoCloud对微博图床进行HTTPS代理</h2>
      <a href="https://github.com/YUX-IO/uwsgi-nginx-flask-docker-for-sinaimg" class="btn">View on GitHub</a>
      <a href="https://github.com/YUX-IO/uwsgi-nginx-flask-docker-for-sinaimg/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/YUX-IO/uwsgi-nginx-flask-docker-for-sinaimg/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <p>Short anwser:</p>

<pre><code>http://ww1.sinaimg.cn/large/863bb56fgw1f3r5e627m9g20jg08cwej.gif

-&gt;

https://sinaimg.daoapp.io/ww1.sinaimg.cn/large/863bb56fgw1f3r5e627m9g20jg08cwej.gif
</code></pre>



<p>俗话说得好——</p>

<blockquote>
<p>围脖是个好图床</p>
</blockquote>

<p>新浪图床作为最优秀的免费图床深得广大群众的喜爱，并一直作为<a href="https://v2ex.com">V站</a>指定图床。在我全站上HTTPS之前，这也一直是我的首选。由于新浪图床的HTTPS证书是自己签发的SHA-1证书，而且根据不同的节点有不同的证书，浏览器都不信任，所以现在我在网站上已经对它放弃。
<img src="https://sinaimg.daoapp.io/ww3.sinaimg.cn/large/863bb56fgw1f3s0cnvfapj21920umk16.jpg" alt="部分地区显示这是铁道部签的证书（╯‵□′）╯︵┴─┴">
直到我转念一想，我做个HTTPS代理不就好了嘛♪(^∇^*)。由于最近比较迷恋Docker，所以打算就用它来解决问题，同时还想复习一下Flask。说到这种代理Flask是有官方代码示例的-<a href="http://flask.pocoo.org/snippets/118/">Stream Proxy with Requests</a></p>

<div class="highlight highlight-source-python"><pre><span class="pl-c"># -*- coding: utf-8 -*-</span>

<span class="pl-k">from</span> flask <span class="pl-k">import</span> Flask
<span class="pl-k">from</span> flask <span class="pl-k">import</span> Response
<span class="pl-k">from</span> flask <span class="pl-k">import</span> stream_with_context

<span class="pl-k">import</span> requests

app <span class="pl-k">=</span> Flask(<span class="pl-c1">__name__</span>)

<span class="pl-en">@app.route</span>(<span class="pl-s"><span class="pl-pds">'</span>/&lt;path:url&gt;<span class="pl-pds">'</span></span>)
<span class="pl-k">def</span> <span class="pl-en">home</span>(<span class="pl-smi">url</span>):
    req <span class="pl-k">=</span> requests.get(url, <span class="pl-v">stream</span> <span class="pl-k">=</span> <span class="pl-c1">True</span>)
    <span class="pl-k">return</span> Response(stream_with_context(req.iter_content()), <span class="pl-v">content_type</span> <span class="pl-k">=</span> req.headers[<span class="pl-s"><span class="pl-pds">'</span>content-type<span class="pl-pds">'</span></span>])

<span class="pl-k">if</span> <span class="pl-c1">__name__</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>__main__<span class="pl-pds">'</span></span>:
    app.run()</pre></div>

<p>这块代码一笔不用动就能直接用，但是我发现主要有两个问题。</p>

<ul>
<li>需要手动添加白名单，我可不想什么资源都能通过代理</li>
<li>Flask自带模块stream_with_context的性能太差，图片加载太慢</li>
</ul>

<p>所以并不能用现成的，那就自己动手撸个小轮子。对于流媒体传输当然是要分块来做！所以就想到chunk，再用正则表达式匹配一下URL是否来自微博图床就可以大功告成咯。正则匹配非常简单用match匹配<code>ww[0-9]\.sinaimg.cn\/</code>搞定，这里有<a href="https://regex101.com/#python">一个非常好用的正则调试工具</a>，最后再用<code>errorhandler</code>应对一下报错，成品如下：</p>

<div class="highlight highlight-source-python"><pre><span class="pl-c"># -*- coding: utf-8 -*-</span>
<span class="pl-k">from</span> flask <span class="pl-k">import</span> Flask, Response, redirect
<span class="pl-k">import</span> requests
<span class="pl-k">import</span> re

app <span class="pl-k">=</span> Flask(<span class="pl-c1">__name__</span>)
app.debug <span class="pl-k">=</span> <span class="pl-c1">False</span>
<span class="pl-c1">CHUNK_SIZE</span> <span class="pl-k">=</span> <span class="pl-c1">2048</span>

<span class="pl-en">@app.route</span>(<span class="pl-s"><span class="pl-pds">'</span>/&lt;path:url&gt;<span class="pl-pds">'</span></span>)
<span class="pl-k">def</span> <span class="pl-en">proxy</span>(<span class="pl-smi">url</span>):
    <span class="pl-k">if</span> <span class="pl-k">not</span> re.match(<span class="pl-sr"><span class="pl-k">r</span><span class="pl-pds">'</span>ww<span class="pl-c1">[</span><span class="pl-c1">0-9</span><span class="pl-c1">]</span><span class="pl-cce">\.</span>sinaimg<span class="pl-c1">.</span>cn<span class="pl-cce">\/</span><span class="pl-pds">'</span></span>, url):
        url <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">"</span>ww3.sinaimg.cn/large/images/default_large.gif<span class="pl-pds">"</span></span>
    r <span class="pl-k">=</span> requests.get(<span class="pl-s"><span class="pl-pds">"</span>http://<span class="pl-pds">"</span></span><span class="pl-k">+</span>url, <span class="pl-v">stream</span><span class="pl-k">=</span><span class="pl-c1">True</span>)
    <span class="pl-k">def</span> <span class="pl-en">generate</span>():
        <span class="pl-k">for</span> chunk <span class="pl-k">in</span> r.iter_content(<span class="pl-c1">CHUNK_SIZE</span>):
            <span class="pl-k">yield</span> chunk
    <span class="pl-k">return</span> Response(generate(), <span class="pl-v">headers</span> <span class="pl-k">=</span> r.raw.headers.items())

<span class="pl-en">@app.errorhandler</span>(<span class="pl-c1">404</span>)
<span class="pl-k">def</span> <span class="pl-en">page_not_found</span>(<span class="pl-smi">e</span>):
    <span class="pl-k">return</span> redirect(<span class="pl-s"><span class="pl-pds">"</span>https://yux.io<span class="pl-pds">"</span></span>)

<span class="pl-en">@app.errorhandler</span>(<span class="pl-c1">500</span>)
<span class="pl-k">def</span> <span class="pl-en">internal_server_rror</span>(<span class="pl-smi">e</span>):
    r <span class="pl-k">=</span> requests.get(<span class="pl-s"><span class="pl-pds">"</span>http://ww3.sinaimg.cn/large/images/default_large.gif<span class="pl-pds">"</span></span>, <span class="pl-v">stream</span><span class="pl-k">=</span><span class="pl-c1">True</span>)
    <span class="pl-k">def</span> <span class="pl-en">generate</span>():
        <span class="pl-k">for</span> chunk <span class="pl-k">in</span> r.iter_content(<span class="pl-c1">CHUNK_SIZE</span>):
            <span class="pl-k">yield</span> chunk
    <span class="pl-k">return</span> Response(generate(), <span class="pl-v">headers</span> <span class="pl-k">=</span> r.raw.headers.items())

<span class="pl-k">if</span> <span class="pl-c1">__name__</span> <span class="pl-k">==</span> <span class="pl-s"><span class="pl-pds">'</span>__main__<span class="pl-pds">'</span></span>:
    app.run()</pre></div>

<p>逻辑部分还算简单，下面开始部署。前面已经说了这次要用Docker，所以就要写个Dockerfile。
Docker的好处根本说不完，这次先说一个就是对于二次开发非常友好，每个开发者都能充分继承上一个开发者的代码再加上自己的修改。Flask掌管的微型服务器需要搭配一些中间件才能正常使用。这么常用的部分当然有人早就写好了，所以上来我先把tiangolo的<a href="https://github.com/tiangolo/uwsgi-nginx-docker">uwsgi-nginx</a>拖下来，然后 <code>RUN pip install flask</code>  <code>RUN pip install requests</code>然后拷贝代码就好啦。
Dockerfile</p>

<div class="highlight highlight-source-dockerfile"><pre><span class="pl-k">FROM</span> tiangolo/uwsgi-nginx:latest

<span class="pl-k">MAINTAINER</span> YUX &lt;yu.xiao.fr@gmail.com&gt;

<span class="pl-k">RUN</span> pip install flask
<span class="pl-k">RUN</span> pip install requests

<span class="pl-c"># Add app configuration to Nginx</span>
<span class="pl-k">COPY</span> nginx.conf /etc/nginx/conf.d/

<span class="pl-c"># Copy sample app</span>
<span class="pl-k">COPY</span> ./app /app</pre></div>

<p>NGINX配置文件</p>

<pre lang="nginx.conf"><code>server {
    location / {
        try_files $uri @app;
    }
    location @app {
        include uwsgi_params;
        uwsgi_pass unix:///tmp/uwsgi.sock;
    }
    location /static {
        alias /app/static;
    }
}
</code></pre>

<p>既然准备工作都做好了，那么接下来开始部署。自己手上国内只有一个阿里云一个美团云，主机分别位于杭州和北京，在国内延迟就很低一般40ms左右。但都是小水管1M带宽肯定撑不起一波一波图片流。境外的主机延迟就高了，基本上在300ms左右，但是水管大都有1G带宽。如果对于大量来自国内的请求带宽上的优势肯定更加明显，我也在美团云和HostUS洛杉矶做了一下实验，HostUS完胜。当初我想做这件事的时候我就希望它是一个持久的公共服务，使命是与微博图床同在。这样的服务放在自己的服务器上感觉并不太妥，所以想到国内无比良心的企业DaoCloud。部署在DaoCloud的项目分配的免费域名daoapp.io配备了泛域名证书，服务器在国内延迟低带宽大，天生就是Docker在国内的好伙伴，所以就开始部署！
进入DaoCloud控制台选择代码构建-创建新项目导入我Github的代码源。这里有一点需要注意，执行环境要选择国外，我也不知道为什么我选择北京 BGP每次构建都会失败。可能一些资源被墙掉了，当然这地点也不重要，最终代码都会部署到国内。导入后需要在DaoCloud构建代码，等待执行成功后就可以在镜像仓库-我的仓库看到了。然后选择部署最新版本-运行环境-DaoCloud即可，不用绑定Volume(如需修改代码也可以绑定到/app)。然后起个好听的域名就OK了！
使用方法很简单，将微博图床链接<code>http://ww1.sinaimg.cn/large/863bb56fgw1f3r5e627m9g20jg08cwej.gif</code>改成<code>https://sinaimg.daoapp.io/ww1.sinaimg.cn/large/863bb56fgw1f3r5e627m9g20jg08cwej.gif</code>就能使用了。
这个图床有如下几个非常好的特性：</p>

<ul>
<li>首先就是支持 HTTPS</li>
<li>之前上传的图片直接修改链接直接就可以使用</li>
<li>微博图床各种方便的上传插件还能继续用</li>
<li>这个图床依托两个很靠谱的平台，新浪和 DaoCloud</li>
<li>可以用 Dockerfile 一键部署在自己的服务器</li>
<li>开源</li>
</ul>

<hr>

<p>P.S.</p>

<ul>
<li><a href="https://regex101.com/#python">一个非常好用的正则调试工具</a></li>
<li>部署Docker <code>docker pull yuxio/uwsgi-nginx-flask-docker-for-sinaimg</code>
</li>
<li>将微博图床链接中ww1改成ws1后再加入https可直接避免浏览器不信任警告，但仍为不安全连接，地址栏https为白色。</li>
<li><a href="https://chrome.google.com/webstore/detail/fdfdnfpdplfbbnemmmoklbfjbhecpnhf">一个非常好用的微博图床Chrome插件</a></li>
<li><a href="https://tinypng.com/">一个非常好用的图片压缩工具</a></li>
<li>
<a href="https://github.com/YUX-IO/uwsgi-nginx-flask-docker-for-sinaimg">项目的Github源</a>，求Star<g-emoji alias="sparkles" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/2728.png">✨</g-emoji>♪(^∇^*)</li>
<li><a href="https://hub.docker.com/r/yuxio/uwsgi-nginx-flask-docker-for-sinaimg/">项目的DockerHub源</a></li>
<li>Acknowledgements 致谢

<ul>
<li><a href="https://github.com/tiangolo/uwsgi-nginx-docker">tiangolo/uwsgi-nginx:latest</a></li>
<li><a href="https://www.daocloud.io">DaoCloud</a></li>
<li><a href="http://weibo.com">Weibo</a></li>
<li><a href="https://v2ex.com">v2ex</a></li>
</ul>
</li>
</ul>

<hr>

<p>handmade by <a href="https://yux.io">YUX</a></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/YUX-IO/uwsgi-nginx-flask-docker-for-sinaimg">Uwsgi-nginx-flask-docker-for-sinaimg</a> is maintained by <a href="https://github.com/YUX-IO">YUX-IO</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
